SYSTEM / TOOL PROMPT — Settings + Persistence + Reconciliation (Dual-Range Compatible)

A) Settings (single page)
- App me ek "Settings" page do with 2 tabs:
  1) Product Prices
     • Grid = (dropshipper_email, product_uid, product_name, sku, product_cost_per_unit, currency, updated_at)
     • Actions: Add Row, Inline Edit, Delete (soft), Filter/Search, Download Template (CSV), Upload CSV (merge).
     • Key = (dropshipper_email, product_uid). Duplicate key → block with error.
     • Currency default = INR if blank. product_cost_per_unit > 0 required.
  2) Shipping Rates
     • Grid = (shipping_provider, shipping_rate_per_order, currency, updated_at)
     • Actions: same as above. Key = shipping_provider. rate > 0 required.
- Pre-fill suggestion: Cleaned data se unique (dropshipper_email, product_uid) aur unique shipping_provider detect karke
  "Add from data" CTA se one-click add karo (empty prices/rates fill karne ko ready).
- Save = persist to DB (or local storage). Har change pe updated_at set karo (IST).
- Bulk CSV headers (strict):
  • Price_Request: dropshipper_email,product_uid,product_name,sku,product_cost_per_unit,currency
  • Shipping_Rate_Request: shipping_provider,shipping_rate_per_order,currency

B) Persistence
- App startup par maps load karo:
  PRICE_MAP(dropshipper_email, product_uid → product_cost_per_unit, currency, updated_at)
  SHIP_MAP(shipping_provider → shipping_rate_per_order, currency, updated_at)
  PAYOUT_LOG(order_id, waybill, dropshipper_email, product_uid, paid_on, period_from, period_to, paid_amount)
- Agar PRICE_MAP / SHIP_MAP me required entries missing hon to:
  • User ko Settings pe le jao ya auto-generate templates do (download + re-upload).
  • Jab tak sab required filled na ho, calc block karo.

C) Dual-Range Flow (unchanged)
1) Raw upload → auto-map (case-insensitive) → Status="Cancelled" rows drop.
2) Pucho: ORDER DATE range (From/To). Non-cancelled rows per provider shipping_rate lagao → Shipping_Total_OrderDate.
3) Pucho: DELIVERED DATE range (From/To). Delivered lines par:
   • COD per-unit = order-level COD / total order qty (round 2).
   • COD_Total_DeliveredDate; ProductCost_Total_DeliveredDate (PRICE_MAP se).
4) Base Payable = COD_Total_DeliveredDate − (Shipping_Total_OrderDate + ProductCost_Total_DeliveredDate).

D) Reconciliation (Delivered → RTS/RTO reversal)
- New upload ke time:
  • For each row: identity = (order_id, waybill, dropshipper_email, product_uid).
  • Agar PAYOUT_LOG me same identity "previously credited" (paid_amount > 0) milta hai AND ab Status contains RTS/RTO
    (ya RTS Date present), to:
      - AdjustmentAmount = −1 × previously credited payable (exact amount paid back then).
      - Current run me "Adjustments" sheet me line add karo with reason="Delivered->RTS/RTO (reversal)" and reference=paid_on/period.
      - Summary me "RTS/RTO Reversal Total" dikhao.
- Also guard:
  • Agar koi order already credited and status abhi bhi Delivered hai (no change) → "Already Paid—Skipped" flag karo, double pay mat karo.
- Final Payable (after recon):
  Final_Payable = Base Payable + SUM(Adjustments)

E) UI Controls
- Fixed top filters:
  • Order Date (for Shipping) — From/To date pickers
  • Delivered Date (for COD & Product Cost) — From/To date pickers
  • Dropshipper Email dropdown (multi/single select). Selection ke hisaab se view/filter apply karo.
- Panels:
  • Summary Cards: {OrderDate Shipping Total, DeliveredDate COD Total, DeliveredDate Product Cost, RTS/RTO Reversal Total, Final Payable}
  • Button: "Download Workbook" → Payout_<YYYYMMDD>.xlsx (IST)
- Same screen se date ranges change hote hi live recompute.

F) Outputs (workbook sheets)
- Master Cleaned (mapped+filtered)
- Payout_<dropshipper_email> (columns: Order ID, Waybill, Product, SKU/UID, Shipped Qty, Delivered Qty,
  COD Rate, COD Received, Shipping Rate, Shipping Cost, Product Cost, Payable, Delivered Date, RTS Date)
- Adjustments (negative lines with reason & reference payout)
- Audit (row inputs + computed fields; flags like Delivered>Shipped, missing price/rate, already-paid)
- Payout Log (append current run)
- Price_Request & Shipping_Rate_Request (only if missing entries remain)

G) Rules & Validations
- Delivered Qty ≤ Shipped Qty else flag in Audit.
- Missing/zero price/rate → block calc; Settings pe redirect option.
- Duplicates: PRICE_MAP key or SHIP_MAP key repeat → error.
- Currency default INR; unit rates round(2), totals round(0). Timezone IST.

H) Recon Pseudocode
for each identity in current cleaned:
  prior = lookup PAYOUT_LOG by (order_id, waybill, dropshipper_email, product_uid)
  if prior.paid_amount > 0 and (status contains 'RTS' or 'RTO' or RTS_Date not null):
      add_adjustment(identity, -prior.paid_amount, reason='Delivered->RTS/RTO')
BasePayable = COD_Total_DeliveredDate - (Shipping_Total_OrderDate + ProductCost_Total_DeliveredDate)
FinalPayable = BasePayable + sum(all adjustments)

I) Copy/Prompts (user-facing microcopy)
- After upload: “Cancelled removed. Pehle Order Date range select kijiye (shipping ke liye).”
- After order range: “Ab Delivered Date range select kijiye (COD & Product Cost ke liye).”
- If missing rates/prices: “X items ke prices/ Y providers ke rates missing hain — Settings me fill karein ya template upload karein.”
- Before export: “Reconciliation complete: ₹<adjust_total> reversed for RTS/RTO. Final Payable ready.”
