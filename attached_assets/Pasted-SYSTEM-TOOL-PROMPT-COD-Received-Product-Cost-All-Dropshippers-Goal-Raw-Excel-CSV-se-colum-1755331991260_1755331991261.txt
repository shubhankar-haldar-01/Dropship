SYSTEM / TOOL PROMPT — COD Received & Product Cost (All Dropshippers)

Goal
- Raw Excel/CSV se columns auto-map karo.
- Row-level par 2 computed columns banao:
  (1) COD_Received_Amount  = (Mode = COD) AND (Status = Delivered/Completed)  →  Qty × ProductValue(per unit)
  (2) Product_Cost_Amount  = (Status = Delivered/Completed)                    →  Qty × ProductCost(per unit)
- Saare dropshippers par group totals nikalo + export sheets.

A) Input & Auto-Mapping (case-insensitive; first match wins)
- Dropshipper Email  ←  Order Account | Seller Email | Dropshipper | Email
- Payment Mode       ←  Mode | Payment Mode | Payment_Type | Pay Mode
- Status             ←  Status | Order Status | Fulfillment Status
- Product Qty        ←  Product Qty | Qty | Quantity
- Product Value/unit ←  Product Value | Item Value | Unit Price | Selling Price (per unit)
- Product Cost/unit  ←  Product Cost | Unit Cost | Buy Cost (per unit)
- (Optional) Delivered Date ← Delivered Date | Delivery Date

Missing mapping → dropdown se user ko map karwao; bina mapping ke calculation block.

B) Data Cleaning
- Currency symbols (₹, INR), commas, spaces ko remove karke numeric banao.
- Non-numeric blanks ko 0 treat NAHIN karna: Invalid flag karo; totals me include mat karo.
- Status/Mode normalization: lowercase, trim; “cash on delivery”, “c.o.d”, “cod ” → “cod”.
- Delivered detection: contains “delivered” OR equals “delivered”/“completed”.

C) Row-Level Formulas (Excel-style)
- Agar sheet ko Excel Table (“Orders”) me convert kar pao to Structured References use karo,
  warna A1 columns letters user ke file ke hisaab se adjust honge.

1) **COD_Received_Amount** (per row)
  Structured (Table ‘Orders’):
  =IF(AND(OR(UPPER([@[Payment Mode]])="COD", ISNUMBER(SEARCH("COD",[@[Payment Mode]]))),
          OR(UPPER([@[Status]])="DELIVERED", UPPER([@[Status]])="COMPLETED",
             ISNUMBER(SEARCH("DELIVERED",[@[Status]])), ISNUMBER(SEARCH("COMPLETED",[@[Status]])))),
     [@[Product Qty]]*[@[Product Value/unit]], 0)

  A1 example (tumhaare reference letters ke mutabik):
  =IF(AND(OR(UPPER($E2)="COD", ISNUMBER(SEARCH("COD",$E2))),
          OR(UPPER($H2)="DELIVERED", UPPER($H2)="COMPLETED",
             ISNUMBER(SEARCH("DELIVERED",$H2)), ISNUMBER(SEARCH("COMPLETED",$H2)))),
     $G2*$I2, 0)

2) **Product_Cost_Amount** (per row)
  Structured:
  =IF(OR(UPPER([@[Status]])="DELIVERED", UPPER([@[Status]])="COMPLETED",
         ISNUMBER(SEARCH("DELIVERED",[@[Status]])), ISNUMBER(SEARCH("COMPLETED",[@[Status]]))),
     [@[Product Qty]]*[@[Product Cost/unit]], 0)

  A1 example:
  =IF(OR(UPPER($H2)="DELIVERED", UPPER($H2)="COMPLETED",
         ISNUMBER(SEARCH("DELIVERED",$H2)), ISNUMBER(SEARCH("COMPLETED",$H2))),
     $G2*$I2, 0)

Notes:
- Dono formulas me **per-unit** values expect ki gayi hain. Agar sheet me Product Value/Cost order-level ho,
  to pehle per-unit derive karo: Order_Level_Amount / ΣQty(by Order ID).

D) Aggregations (All Dropshippers)
- “Payout_Summary” sheet (group by Dropshipper Email):
  Columns:
   • Dropshipper Email
   • COD_Received_Total        = SUM(COD_Received_Amount)
   • Product_Cost_Total        = SUM(Product_Cost_Amount)
   • Net (optional)            = COD_Received_Total − Product_Cost_Total
   • Rows_Count_Used
   • Invalid_Rows_Count
- Optional filters:
   • Delivered Date range (agar mapped ho) → summary & detail dono usi range par run hon.

E) Outputs (auto-generated)
1) Master_Cleaned: mapped columns + normalized numbers + invalid flags.
2) Detail_All: original + 2 computed columns (COD_Received_Amount, Product_Cost_Amount).
3) Payout_Summary (per dropshipper aggregates).
4) (Optional) Payout_<dropshipper_email> detail splits.
5) Export: COD_ProductCost_<YYYYMMDD>.xlsx (IST) with sabhi sheets.

F) Rules & Validations
- Missing required columns (Mode, Status, Qty, Product Value/unit, Product Cost/unit) → block & prompt.
- Invalid numeric cells → Detail_All me flag; totals se exclude.
- Currency: INR; unit math → 2 decimals; displayed totals → 0 decimals (configurable).
- Delivered Qty ≤ Shipped Qty rule (agar Shipped available ho) → breach ko Audit flag me daalo.
- Case-insensitive matching; strings trimmed.

G) UI Microcopy
- “Map columns: Dropshipper Email, Mode, Status, Qty, Product Value (unit), Product Cost (unit), Delivered Date (optional).”
- “COD Received = sum of (Qty × Product Value unit) for rows where Mode=COD and Status=Delivered/Completed.”
- “Product Cost = sum of (Qty × Product Cost unit) for rows where Status=Delivered/Completed.”
- “{n} rows invalid amounts ki wajah se exclude kiye gaye—download detail to review.”

H) Pseudocode (engine)
rows = load_and_map()
for r in rows:
  mode = norm(r.mode); status = norm(r.status)
  qty = to_number(r.qty); val_u = to_number(r.product_value_u); cost_u = to_number(r.product_cost_u)
  cod_ok = (contains(mode,"cod"))
  del_ok = (equals(status,"delivered") or contains(status,"delivered") or equals(status,"completed") or contains(status,"completed"))
  COD_Received_Amount = (cod_ok and del_ok and valid(qty,val_u)) ? qty*val_u : 0
  Product_Cost_Amount = (del_ok and valid(qty,cost_u)) ? qty*cost_u : 0
aggregate by dropshipper; write sheets; export
